name: Deploy to Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 2

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail
            REPO_DIR=~/GitRepositories/datizrace-proj-1

            echo "Updating repo ..."
            cd "$REPO_DIR"
            git pull origin main

            BEFORE=${{ github.event.before }}
            AFTER=${{ github.sha }}
            if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || ! git cat-file -e "$BEFORE" 2>/dev/null; then
              BEFORE="$(git rev-parse HEAD~1)"
            fi

            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
            echo "Changed files between $BEFORE and $AFTER:"
            if [ -n "$CHANGED" ]; then
              printf '%s\n' "$CHANGED"
            else
              echo "(none)"
            fi

            cd "$REPO_DIR/Application"
            if printf '%s\n' "$CHANGED" | grep -Eq '^(Application/(mlflow|ml-app-1|ml-app-2|caddy)/|Application/docker-compose\.yml)'; then
              echo "Detected infrastructure/ service changes. Restarting full stack..."
              docker compose down
              docker compose up -d --build --remove-orphans
            else
              echo "Only ML project changes detected. Rebuilding targeted services..."
              docker compose build ml-projekts-1 ml-projekts-2
              docker compose up -d --no-deps --force-recreate ml-projekts-1 ml-projekts-2
            fi

            echo "Deploy finished"
